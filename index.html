<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Walkie Talkie PRO</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');
    
    body {
      margin: 0; padding: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace;
      overflow: hidden; height: 100vh; display: flex; flex-direction: column;
      background: linear-gradient(135deg, #001a00, #000);
    }
    #header {
      text-align: center; padding: 20px; font-family: 'Orbitron', sans-serif;
      font-size: 32px; text-shadow: 0 0 20px #0f0; letter-spacing: 3px;
    }
    #channelBox {
      text-align: center; margin: 10px;
    }
    #channelInput {
      width: 120px; height: 50px; font-size: 28px; text-align: center;
      background: #000; color: #0f0; border: 3px solid #0f0; border-radius: 15px;
      box-shadow: 0 0 20px #0f0;
    }
    #ptt {
      width: 280px; height: 280px; margin: 30px auto; border-radius: 50%;
      background: radial-gradient(circle, #003300, #000);
      border: 12px solid #0f0; box-shadow: 0 0 60px #0f0, inset 0 0 40px #003300;
      display: flex; align-items: center; justify-content: center; font-size: 28px;
      font-weight: bold; text-align: center; user-select: none; transition: all 0.1s;
    }
    .talking { background: radial-gradient(circle, #330000, #000) !important; 
               border-color: #f00 !important; box-shadow: 0 0 80px #f00, inset 0 0 60px #600 !important; }
    #status {
      text-align: center; font-size: 20px; margin: 20px; text-shadow: 0 0 10px #0f0;
    }
    #users { text-align: center; color: #0f0; font-size: 14px; }
    .pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
  </style>
</head>
<body>

  <div id="header">WALKIE PRO</div>

  <div id="channelBox">
    <label>CANAL: </label>
    <input type="number" id="channelInput" min="1" max="999" value="13"/>
    <button onclick="joinChannel()" style="margin-left:10px;padding:10px 20px;font-size:18px;background:#0f0;color:#000;border:none;border-radius:10px;">
      UNIRSE
    </button>
  </div>

  <div id="ptt" ontouchstart="startTalking(event)" ontouchend="stopTalking()" 
       onmousedown="startTalking(event)" onmouseup="stopTalking()" onmouseleave="stopTalking()">
    PRESIONA Y HABLA<br><span style="font-size:18px;">Canal <span id="currentChannel">?</span></span>
  </div>

  <div id="status">Conectando al canal...</div>
  <div id="users">Usuarios en línea: <span id="userCount">0</span></div>

  <script>
    const SERVER_URL = "https://ruminot21.github.io/Radio-walkie-talkie-/"; // Servidor público gratuito (siempre activo)
    let socket = null;
    let channel = 13;
    let myId = Math.random().toString(36).substr(2,9);
    let isTalking = false;
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let mediaStream = null;
    let sourceNode = null;
    let processor = null;
    let peers = {};

    document.getElementById('currentChannel').innerText = channel;

    function joinChannel() {
      channel = parseInt(document.getElementById('channelInput').value) || 13;
      if (channel < 1) channel = 1;
      if (channel > 999) channel = 999;
      document.getElementById('currentChannel').innerText = channel;
      document.getElementById('status').innerText = `Uniéndote al canal ${channel}...`;
      connectWebSocket();
    }

    function connectWebSocket() {
      if (socket) socket.close();
      socket = new WebSocket(SERVER_URL);

      socket.onopen = () => {
        socket.send(JSON.stringify({type: "join", channel, id: myId}));
        document.getElementById('status').innerHTML = `<span class="pulse">● Canal ${channel} - CONECTADO</span>`;
      };

      socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "users") {
          document.getElementById('userCount').innerText = msg.count;
        }
        if (msg.type === "audio" && msg.id !== myId) {
          playAudio(msg.data);
        }
      };

      socket.onclose = () => {
        document.getElementById('status').innerText = "Desconectado. Reconectando...";
        setTimeout(connectWebSocket, 2000);
      };
    }

    async function startTalking(e) {
      e.preventDefault();
      if (isTalking) return;
      isTalking = true;
      document.getElementById('ptt').classList.add('talking');
      document.getElementById('ptt').innerHTML = "¡HABLANDO!<br><span style='font-size:20px'>Suelta para parar</span>";
      document.getElementById('status').innerHTML = "● TRANSMITIENDO...";

      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({audio: true});
        sourceNode = audioContext.createMediaStreamSource(mediaStream);
        processor = audioContext.createScriptProcessor(2048, 1, 1);

        processor.onaudioprocess = (e) => {
          if (!isTalking) return;
          const input = e.inputBuffer.getChannelData(0);
          const bufferData = new Float32Array(input);
          const base64 = btoa(String.fromCharCode(...new Uint8Array(bufferData.buffer)));
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
              type: "audio",
              channel,
              id: myId,
              data: base64
            }));
          }
        };

        sourceNode.connect(processor);
        processor.connect(audioContext.destination);
      } catch (err) {
        alert("Necesitas permitir el micrófono");
      }
    }

    function stopTalking() {
      if (!isTalking) return;
      isTalking = false;
      document.getElementById('ptt').classList.remove('talking');
      document.getElementById('ptt').innerHTML = `PRESIONA Y HABLA<br><span style="font-size:18px;">Canal ${channel}</span>`;
      document.getElementById('status').innerHTML = `<span class="pulse">● Canal ${channel} - ESCUCHANDO</span>`;

      if (processor) {
        processor.disconnect();
        processor.onaudioprocess = null;
        processor = null;
      }
      if (sourceNode) {
        sourceNode.disconnect();
        sourceNode = null;
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
    }

    function playAudio(base64) {
      try {
        const binary = atob(base64);
        const array = new Float32Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          array[i] = (binary.charCodeAt(i) - 128) / 128;
        }
        const buffer = audioContext.createBuffer(1, array.length, 48000);
        buffer.getChannelData(0).set(array);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
      } catch(e) {}
    }

    // Auto-conectar al cargar
    window.onload = () => joinChannel();
  </script>
</body>
</html>
