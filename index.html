<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WALKIE TACTICAL PRO</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
  <style>
    :root{--green:#00ff41;--red:#ff0033;--dark:#000;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--dark);color:var(--green);font-family:'Rajdhani',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;
      background:radial-gradient(circle at center,#001a0a 0%,#000 70%);}
    #header{font-family:'Orbitron',sans-serif;font-size:42px;font-weight:900;text-align:center;padding:20px 0 10px;
      text-shadow:0 0 30px var(--green),0 0 60px var(--green);letter-spacing:8px;}
    .scanline{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(transparent 50%,rgba(0,255,65,0.03)50%);
      background-size:100% 4px;animation:scan 8s linear infinite;pointer-events:none;}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
    #channelBox{text-align:center;margin:15px 0;}
    #channelInput{width:140px;height:60px;font-size:36px;text-align:center;background:rgba(0,0,0,0.8);color:var(--green);border:3px solid var(--green);border-radius:12px;
      box-shadow:0 0 30px rgba(0,255,65,0.6);}
    #joinBtn{margin-left:15px;padding:15px 30px;font-size:20px;background:linear-gradient(145deg,#003300,#00ff41);color:#000;border:none;border-radius:12px;
      box-shadow:0 0 30px rgba(0,255,65,0.8);cursor:pointer;}
    #ptt{width:300px;height:300px;margin:40px auto;border-radius:50%;background:radial-gradient(circle at 30% 30%,#004400,#000811);
      border:14px solid var(--green);box-shadow:0 0 80px rgba(0,255,65,0.8),inset 0 0 60px rgba(0,0,0,0.9);
      display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;}
    #ptt::before{content:'';position:absolute;width:100%;height:100%;background:conic-gradient(from 0deg at 50% 50%,transparent,rgba(0,255,65,0.1)30deg,transparent 60deg);
      animation:radar 20s linear infinite;opacity:0.3;}
    @keyframes radar{to{transform:rotate(360deg)}}
    .talking{background:radial-gradient(circle at 30% 30%,#440000,#110000)!important;border-color:var(--red)!important;
      box-shadow:0 0 120px #ff0033,0 0 200px #ff0033!important;animation:pulseRed 1s infinite alternate;}
    @keyframes pulseRed{from{box-shadow:0 0 120px #ff0033}to{box-shadow:0 0 180px #ff0033}}
    #status{text-align:center;font-size:26px;margin:20px;text-shadow:0 0 20px var(--green);}
    .indicator{display:inline-block;width:18px;height:18px;border-radius:50%;background:var(--green);box-shadow:0 0 20px var(--green);
      animation:pulse 2s infinite;margin-right:10px;vertical-align:middle;}
    .tx{background:#ff0033!important;box-shadow:0 0 30px #ff0033!important;animation:pulse 0.5s infinite!important;}
    @keyframes pulse{0%,100%{opacity:0.6}50%{opacity:1}}
    #unlock{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;
      color:#0f0;font-size:32px;text-align:center;padding-top:40vh;}
  </style>
</head>
<body>

  <!-- Pantalla de desbloqueo de audio (solo aparece la primera vez) -->
  <div id="unlock">TOCA LA PANTALLA PARA ACTIVAR EL MICRÓFONO</div>

  <div class="scanline"></div>
  <div id="header">TACTICAL COMM</div>

  <div id="channelBox">
    <label style="font-size:22px;text-shadow:0 0 10px;">FRECUENCIA</label><br>
    <input type="number" id="channelInput" min="1" max="999" value="13">
    <button id="joinBtn" onclick="joinChannel()">CONECTAR</button>
  </div>

  <div id="ptt">
    <div style="font-size:52px;text-shadow:0 0 30px;">PTT</div>
    <div style="font-size:20px;margin-top:10px;">CANAL <span id="currentChannel">13</span></div>
  </div>

  <div id="status"><span class="indicator" id="led"></span> CONECTANDO...</div>

  <script>
    // TUS CREDENCIALES (ya puestas)
    const pusher = new Pusher('fc0eb734d53f2df68607', { cluster: 'us2', forceTLS: true });

    let channel = null;
    let currentNumber = 13;
    let myId = Math.random().toString(36).substring(7);
    let talking = false;
    let audioCtx = null;
    let processor = null;
    let stream = null;

    // === DESBLOQUEO DE AUDIO AL PRIMER TOQUE ===
    document.getElementById('unlock').addEventListener('touchstart', unlockAudio, {once: true});
    document.getElementById('unlock').addEventListener('click', unlockAudio, {once: true});

    async function unlockAudio(e) {
      e.preventDefault();
      document.getElementById('unlock').style.display = 'none';
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      joinChannel();
    }

    function joinChannel() {
      const num = Math.max(1, Math.min(999, parseInt(document.getElementById('channelInput').value) || 13));
      currentNumber = num;
      document.getElementById('currentChannel').innerText = num;

      if (channel) channel.unsubscribe();
      channel = pusher.subscribe(`walkie-${num}`);

      channel.bind('pusher:subscription_succeeded', () => {
        document.getElementById('status').innerHTML = `<span class="indicator"></span> CANAL ${num} ● CONECTADO`;
      });

      channel.bind('client-audio', data => {
        if (data.id === myId) return;
        playAudio(data.chunk);
      });
    }

    // === PTT (ahora sí funciona en móviles) ===
    const ptt = document.getElementById('ptt');
    ptt.addEventListener('touchstart', startTalking);
    ptt.addEventListener('touchend', stopTalking);
    ptt.addEventListener('mousedown', startTalking);
    ptt.addEventListener('mouseup', stopTalking);
    ptt.addEventListener('mouseleave', stopTalking);

    async function startTalking(e) {
      e.preventDefault();
      if (talking || !audioCtx) return;
      talking = true;

      ptt.classList.add('talking');
      ptt.innerHTML = `<div style="font-size:48px;">TX</div><div style="font-size:22px;margin-top:10px;">TRANSMITIENDO…</div>`;
      document.getElementById('status').innerHTML = `<span class="indicator tx"></span> TRANSMITIENDO`;

      try {
        stream = await navigator.mediaDevices.getUserMedia({audio: true});
        const source = audioCtx.createMediaStreamSource(stream);
        processor = audioCtx.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = e => {
          if (!talking) return;
          const input = e.inputBuffer.getChannelData(0);
          const pcm = new Int16Array(input.length);
          for (let i = 0; i < input.length; i++) pcm[i] = input[i] * 32767;
          const base64 = btoa(String.fromCharCode(...new Uint8Array(pcm.buffer)));
          channel.trigger('client-audio', { id: myId, chunk: base64 });
        };

        source.connect(processor);
        processor.connect(audioCtx.destination);
      } catch(err) {
        alert("¡Permití el micrófono!");
        stopTalking();
      }
    }

    function stopTalking() {
      if (!talking) return;
      talking = false;

      ptt.classList.remove('talking');
      ptt.innerHTML = `<div style="font-size:52px;text-shadow:0 0 30px;">PTT</div><div style="font-size:20px;margin-top:10px;">CANAL ${currentNumber}</div>`;
      document.getElementById('status').innerHTML = `<span class="indicator"></span> CANAL ${currentNumber} ● ESCUCHANDO`;

      if (processor) processor.disconnect();
      if (stream) stream.getTracks().forEach(t => t.stop());
      processor = stream = null;
    }

    function playAudio(base64) {
      try {
        const bin = atob(base64);
        const len = bin.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
        const pcm16 = new Int16Array(bytes.buffer);
        const float32 = new Float32Array(pcm16.length);
        for (let i = 0; i < pcm16.length; i++) float32[i] = pcm16[i] / 32768;

        const buffer = audioCtx.createBuffer(1, float32.length, audioCtx.sampleRate);
        buffer.getChannelData(0).set(float32);
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        src.connect(audioCtx.destination);
        src.start(0);
      } catch(e) {}
    }
  </script>
</body>
</html>
